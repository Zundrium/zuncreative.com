---
import Button from "./Button.astro";
import DarkAndLightSwitch from "./DarkAndLightSwitch.astro";
import LanguageLinks from "./LanguageLinks.astro";
import MdiMenu from "~icons/mdi/menu";
import MdiClose from "~icons/mdi/close";
import { m, getLocale } from "../../lib/i18n";

const lang = getLocale();
const prefix = lang === "en" ? "" : `/${lang}`;

const navLinks = [
    { name: m.nav_about_me(), href: `${prefix}/#about-me` },
    { name: m.nav_blog(), href: `${prefix}/blog` },
    { name: m.nav_showcase(), href: `${prefix}/#showcase` },
    { name: m.nav_contact(), href: `${prefix}/#contact`, style: "line" },
];

const isHome = Astro.url.pathname === "/";
---

<div
    class="hidden md:flex relative z-10 h-6 text-neutral-600 dark:text-neutral-500 w-full items-center justify-center bg-neutral-100 dark:bg-neutral-900 duration-300"
>
    <div class="container flex items-center px-6 py-2 justify-between text-xs">
        <nav aria-label={m.nav_aria_top_center()}>
            <ul class="flex gap-8">
                <li>
                    <a
                        class="cursor-pointer hover:underline"
                        href={`${prefix}/privacy`}>{m.nav_privacy()}</a
                    >
                </li>
                <li>
                    <a
                        class="cursor-pointer hover:underline"
                        href={`${prefix}/terms`}
                    >
                        {m.nav_terms_and_conditions()}
                    </a>
                </li>
            </ul>
        </nav>
        <nav aria-label={m.nav_aria_top_left()}>
            <DarkAndLightSwitch />
        </nav>
        <nav aria-label={m.nav_aria_language_select()}>
            <LanguageLinks />
        </nav>
    </div>
</div>

<header
    id="navbar"
    class="sticky flex flex-col items-center z-50 top-0 left-0 right-0"
    data-is-home={isHome}
>
    <div
        id="navbar-bg"
        class="w-full transition-colors duration-300 flex justify-center h-18 -mb-24 bg-transparent text-black dark:text-white"
    >
        <div
            class="container transition-colors duration-300 px-6 py-3 lg:py-3 flex flex-col lg:flex-row justify-between items-center max-h-dvh"
        >
            <div
                id="nav-content"
                class="w-full flex items-center justify-between"
            >
                <div
                    class="lg:flex-1 flex lg:h-full w-full items-center justify-between"
                >
                    <a
                        href={prefix || "/"}
                        class="cursor-pointer relative w-12 h-12"
                        aria-label={m.nav_aria_home()}
                    >
                        <object
                            class="absolute pointer-events-none inset-0 w-full h-full duration-300 opacity-0 logo-opaque"
                            data="/svg/logo.svg"
                            type="image/svg+xml"
                            title={m.nav_logo_title()}></object>
                        <object
                            class="absolute pointer-events-none inset-0 w-full h-full duration-300 invert dark:invert-0 opacity-100 logo-transparent"
                            data="/svg/logo-white.svg"
                            type="image/svg+xml"
                            title={m.nav_logo_title()}></object>
                    </a>

                    <button
                        id="mobile-menu-btn"
                        class="size-12 p-2 cursor-pointer lg:hidden"
                        aria-label={m.nav_aria_open_menu()}
                        aria-expanded="false"
                        aria-controls="mobile-nav"
                    >
                        <div class="relative h-full w-full">
                            <span class="sr-only">{m.nav_menu_open_text()}</span
                            >
                            <div
                                id="icon-menu"
                                class="absolute left-0 top-0 h-full w-full transition-transform duration-300 scale-100 rotate-0"
                            >
                                <MdiMenu class="size-10" />
                            </div>
                            <div
                                id="icon-close"
                                class="absolute left-0 top-0 h-full w-full transition-transform duration-300 scale-0 -rotate-180"
                            >
                                <MdiClose class="size-10" />
                            </div>
                        </div>
                    </button>
                </div>

                <nav
                    aria-label={m.nav_aria_primary()}
                    class="flex-1 transition-opacity duration-300 justify-center items-center md:justify-end text-xl md:text-base h-full hidden lg:flex"
                    id="mobile-nav"
                >
                    <ul
                        class="flex flex-col lg:flex-row gap-2 lg:gap-4 items-center justify-center h-full"
                    >
                        {
                            navLinks.map((navLink) => (
                                <li class="flex flex-col flex-none items-center w-full lg:w-auto lg:border-none border-black/10 dark:border-white/10 py-2">
                                    <Button
                                        style={(navLink.style as any) || "text"}
                                        href={navLink.href}
                                        class="mobile-nav-link"
                                    >
                                        {navLink.name}
                                    </Button>
                                </li>
                            ))
                        }
                    </ul>

                    <div
                        class="lg:hidden flex flex-col items-center gap-6 mt-6"
                    >
                        <LanguageLinks />
                        <DarkAndLightSwitch />
                    </div>
                </nav>
            </div>
        </div>
    </div>
</header>

<script>
    function initNavbar() {
        const navbar = document.getElementById("navbar");
        const navbarBg = document.getElementById("navbar-bg");
        const mobileMenuBtn = document.getElementById("mobile-menu-btn");
        const mobileNav = document.getElementById("mobile-nav");
        const navContent = document.getElementById("nav-content");
        const iconMenu = document.getElementById("icon-menu");
        const iconClose = document.getElementById("icon-close");
        const logoOpaque = document.querySelector(".logo-opaque");
        const logoTransparent = document.querySelector(".logo-transparent");

        if (
            !navbar ||
            !navbarBg ||
            !mobileMenuBtn ||
            !mobileNav ||
            !navContent ||
            !iconMenu ||
            !iconClose
        )
            return;

        let mobileNavOpen = false;
        const isHome = navbar.getAttribute("data-is-home") === "true";
        const mainNavTransparent =
            "bg-transparent dark:bg-gradient-to-b dark:from-black/70 dark:to-transparent text-black dark:text-white";
        const mainNavOpaque =
            "bg-white dark:bg-black text-black dark:text-white";

        function updateNavbarState() {
            const scrollY = window.scrollY;
            const isOpaque =
                (!isHome && scrollY > 50) ||
                (isHome && scrollY > 3500) ||
                mobileNavOpen;

            if (isOpaque) {
                navbarBg!.className = `w-full transition-colors duration-300 flex justify-center h-18 -mb-24 ${mainNavOpaque} ${mobileNavOpen ? "h-dvh" : ""}`;
                logoOpaque?.classList.remove("opacity-0");
                logoOpaque?.classList.add("opacity-100");
                logoTransparent?.classList.remove("opacity-100");
                logoTransparent?.classList.add("opacity-0");
            } else {
                navbarBg!.className = `w-full transition-colors duration-300 flex justify-center h-18 -mb-24 ${mainNavTransparent} ${mobileNavOpen ? "h-dvh bg-white dark:bg-black" : ""}`;
                logoOpaque?.classList.add("opacity-0");
                logoOpaque?.classList.remove("opacity-100");
                logoTransparent?.classList.add("opacity-100");
                logoTransparent?.classList.remove("opacity-0");
            }
        }

        function toggleMobileNav() {
            mobileNavOpen = !mobileNavOpen;
            mobileMenuBtn?.setAttribute("aria-expanded", String(mobileNavOpen));

            if (mobileNavOpen) {
                mobileNav?.classList.remove("hidden");
                mobileNav?.classList.add(
                    "flex",
                    "flex-col",
                    "items-center",
                    "w-full",
                );
                navContent?.classList.add("flex-col", "h-dvh", "pb-6");

                iconMenu?.classList.remove("scale-100", "rotate-0");
                iconMenu?.classList.add("scale-0", "rotate-180");

                iconClose?.classList.remove("scale-0", "-rotate-180");
                iconClose?.classList.add("scale-100", "rotate-0");
            } else {
                mobileNav?.classList.add("hidden");
                mobileNav?.classList.remove(
                    "flex",
                    "flex-col",
                    "items-center",
                    "w-full",
                );
                navContent?.classList.remove("flex-col", "h-dvh", "pb-6");

                iconMenu?.classList.add("scale-100", "rotate-0");
                iconMenu?.classList.remove("scale-0", "rotate-180");

                iconClose?.classList.add("scale-0", "-rotate-180");
                iconClose?.classList.remove("scale-100", "rotate-0");
            }
            updateNavbarState();
        }

        mobileMenuBtn.addEventListener("click", toggleMobileNav);
        window.addEventListener("scroll", updateNavbarState);

        // Initial check
        updateNavbarState();

        // Close mobile nav on link click
        const links = document.querySelectorAll(".mobile-nav-link");
        links.forEach((link) => {
            link.addEventListener("click", () => {
                if (mobileNavOpen) toggleMobileNav();
            });
        });

        // Navbar scroll margin logic
        function updateNavbarScrollMargin() {
            document.documentElement.style.setProperty(
                "--navbar-scroll-margin",
                `${navbar!.offsetHeight / 2}px`,
            );
        }
        updateNavbarScrollMargin();
        window.addEventListener("resize", updateNavbarScrollMargin);
    }

    initNavbar();
    document.addEventListener("astro:page-load", initNavbar);
</script>
